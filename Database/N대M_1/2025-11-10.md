# Many to many relationships

í•œ í…Œì´ë¸”ì˜ 0ê°œ ì´ìƒì˜ ë ˆì½”ë“œê°€ ë‹¤ë¥¸ í…Œì´ë¸”ì˜ 0ê°œ ì´ìƒì˜ ë ˆì½”ë“œì™€ ê´€ë ¨ëœ ê²½ìš°

### N:1 ì˜ í•œê³„

- ë™ì¼í•œ í™˜ìì§€ë§Œ ë‹¤ë¥¸ ì˜ì‚¬ì—ê²Œë„ ì§„ë£Œ ë°›ê¸° ìœ„í•´ ìƒˆë¡œìš´ ì˜ˆì•½ ë°ì´í„°ë¥¼ ë§Œë“¤ì–´ì•¼ í•˜ë©°, ì´ ë•Œ ë™ì¼í•œ í™˜ì ì •ë³´ë¥¼ ë˜ ì‘ì„±í•˜ì—¬ ì €ì¥ë¨(**ì¼ê´€ì„±ì´ ê¹¨ì§ˆ ë¬¸ì œê°€ ìˆìŒ**)
    - ì´ëŸ° êµ¬ì¡°ë¡œ ì˜ì‚¬ì™€ í™˜ìì˜ ì§„ë£Œ ê´€ê³„ë¥¼ ì„¤ì •í•œë‹¤ë©´
    - í™˜ì í•œ ëª…ì˜ ë‘ ì˜ì‚¬ ëª¨ë‘ì—ê²Œ ì§„ë£Œë¥¼ ë°›ê³ ì í•  ë•Œ, í™˜ì í…Œì´ë¸”ì— ê°™ì€ í™˜ìê°€ ì¤‘ë³µìœ¼ë¡œ ì…ë ¥ëœë‹¤
- ì œ 1 ì •ê·œí˜•ì„ ë§Œì¡±í•˜ì§€ ëª»í•œë‹¤
    - í™˜ìê°€ ì§„ë£Œ ë°›ì„ ì˜ì‚¬ ì •ë³´ë¥¼ `1,2` ì´ë ‡ê²Œ ë™ì‹œì— ì €ì¥ì„ ì‹œë„í•˜ë©´ ì—ëŸ¬ê°€ ë°œìƒí•¨

```python
class Doctor(models.Model):
    name = models.TextField()

    def __str__(self):
        return f'{self.pk}ë²ˆ ì˜ì‚¬ {self.name}'

class Patient(models.Model):
    doctor = models.ForeignKey(Doctor, on_delete=models.CASCADE)
    name = models.TextField()

    def __str__(self):
        return f'{self.pk}ë²ˆ í™˜ì {self.name}'
```

### 1. 1:N í•œê³„ë¥¼ ì¤‘ê°œ ëª¨ë¸ë¡œ í•´ê²°

ì¤‘ê°œ ëª¨ë¸: ë‹¤ëŒ€ë‹¤ ê´€ê³„ì—ì„œ `ë‘ ëª¨ë¸ì„ ì—°ê²°í•˜ëŠ” ì—­í• `ì„ í•˜ëŠ” ê¸°ëŠ¥ì„ ê°€ì§„ ëª¨ë¸ 

- ì˜ˆì•½ ì •ë³´ ì¡°íšŒ : ì¤‘ê°œ í…Œì´ë¸”ì˜ ì—­ì°¸ì¡°ë¥¼ í†µí•´ ê°€ëŠ¥
    - `doctor1.reservation_set.all()`
    - `patient1.reservation_set.all()`

```python
class Doctor(models.Model):
    name = models.TextField()

    def __str__(self):
        return f'{self.pk}ë²ˆ ì˜ì‚¬ {self.name}'

# ì™¸ë˜í‚¤ ì‚­ì œ
class Patient(models.Model):
    name = models.TextField()

    def __str__(self):
        return f'{self.pk}ë²ˆ í™˜ì {self.name}'

# ì¤‘ê°œëª¨ë¸ ì‘ì„±
class Reservation(models.Model):
    doctor = models.ForeignKey(Doctor, on_delete=models.CASCADE)
    patient = models.ForeignKey(Patient, on_delete=models.CASCADE)

    def __str__(self):
        return f'{self.doctor_id}ë²ˆ ì˜ì‚¬ì˜ {self.patient_id}ë²ˆ í™˜ì'
```

### 2. ManyToManyField

- ì¥ì 
    - M:N ê´€ê³„ ì„¤ì • ëª¨ë¸ í•„ë“œë¡œ ì¤‘ê°œ ëª¨ë¸ì„ ìë™ìœ¼ë¡œ ìƒì„±í•  ìˆ˜ ìˆë‹¤.
    - `.add()` ì™€ `.remove()` ë©”ì„œë“œ ì‚¬ìš© ê°€ëŠ¥
        - `patient.doctors.add(doctor1)`
        - `patient.doctors.add(doctor1, doctor3)`
        - `patient.doctor.remove(doctor1)`
        - `patient.doctors.remove(doctor2, doctor3)`
- í•œê³„
    - ê¸°ë³¸ ManyToManyFieldë¡œ ìƒì„±ëœ ì˜ˆì•½ ì¤‘ê°œ í…Œì´ë¸”ì€ ì˜ì‚¬ì™€ í™˜ìì˜ ì™¸ë˜ í‚¤ ì •ë³´ë§Œ ì €ì¥í•˜ê³  ìˆìŒ
    - ë§Œì•½ ì˜ˆì•½ ì¤‘ê°œ í…Œì´ë¸”ì— ë³‘ì˜ ì¦ìƒ, ì˜ˆì•½ ì¼ì •, ë°©ë¬¸ íšŸìˆ˜ì— ëŒ€í•œ ì¶”ê°€ ì •ë³´ê°€ í•„ìš”í•œ ê²½ìš° ManyToManyFieldë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•  ìˆ˜ ì—†ìŒ
    - ì¶”ê°€ ì •ë³´ë¥¼ ì €ì¥í•˜ê¸° ìœ„í•´ì„œëŠ” ì‚¬ìš©ìê°€ ì§ì ‘ ì¤‘ê°œ í…Œì´ë¸”ì„ ì •ì˜í•´ì•¼ í•¨
        - í•˜ì§€ë§Œ ì´ë ‡ê²Œ ë˜ë©´ `.add()` , `.remove()` ì— ë©”ì„œë“œë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŒ

```python
class Doctor(models.Model):
    name = models.TextField()

    def __str__(self):
        return f'{self.pk}ë²ˆ ì˜ì‚¬ {self.name}'

class Patient(models.Model):
    # ManyToManyField ì‘ì„±
    doctors = models.ManyToManyField(Doctor)
    name = models.TextField()

    def __str__(self):
        return f'{self.pk}ë²ˆ í™˜ì {self.name}'
```

### 3. â€˜throughâ€™ argument

â€˜throughâ€™ ì†ì„± : ì¤‘ê°œ í…Œì´ë¸”ì— â€˜ì¶”ê°€ ë°ì´í„°â€™ë¥¼ ì‚¬ìš©í•´ M:N ê´€ê³„ë¥¼ í˜•ì„±í•˜ë ¤ëŠ” ê²½ìš°ì— ì‚¬ìš©

- `.add()` ì™€ `.remove()` ë„ ì—­ì‹œ ì‚¬ìš© ê°€ëŠ¥!

```python
class Doctor(models.Model):
    name = models.TextField()

    def __str__(self):
        return f'{self.pk}ë²ˆ ì˜ì‚¬ {self.name}'

class Patient(models.Model):
    doctors = models.ManyToManyField(Doctor, through='Reservation')
    name = models.TextField()

    def __str__(self):
        return f'{self.pk}ë²ˆ í™˜ì {self.name}'

class Reservation(models.Model):
    doctor = models.ForeignKey(Doctor, on_delete=models.CASCADE)
    patient = models.ForeignKey(Patient, on_delete=models.CASCADE)
    symptom = models.TextField()
    reserved_at = models.DateTimeField(auto_now_add=True)

    def __str__(self):
        return f'{self.doctor.pk}ë²ˆ ì˜ì‚¬ì˜ {self.patient.pk}ë²ˆ í™˜ì'
```

### M:N ê´€ê³„ ì£¼ìš” ì‚¬í•­ ì •ë¦¬

- **M:N ê´€ê³„ë¡œ ë§ºì–´ì§„ ë‘ í…Œì´ë¸”ì—ëŠ” ë¬¼ë¦¬ì ì¸ ë³€í™”ê°€ ì—†ìŒ**
- **ManyToManyFieldëŠ” ì¤‘ê°œ í…Œì´ë¸”ì„ ìë™ìœ¼ë¡œ ìƒì„±**
- **ManyToManyFieldëŠ” M:N ê´€ê³„ë¥¼ ë§ºëŠ” ë‘ ëª¨ë¸ ì–´ë””ì— ìœ„ì¹˜í•´ë„ ìƒê´€ ì—†ìŒ**
    - ëŒ€ì‹  í•„ë“œ ì‘ì„± ìœ„ì¹˜ì— ë”°ë¼ ì°¸ì¡°ì™€ ì—­ì°¸ì¡° ë°©í–¥ì„ ì£¼ì˜í•  ê²ƒ
- **N:1ì€ ì™„ì „í•œ ì¢…ì†ì˜ ê´€ê³„**ì˜€ì§€ë§Œ **M:Nì€ ì¢…ì†ì ì¸ ê´€ê³„ê°€ ì•„ë‹ˆë©°** â€˜ì˜ì‚¬ì—ê²Œ ì§„ì°°ë°›ëŠ” í™˜ìâ€™ & â€˜í™˜ìë¥¼ ì§„ì°°í•˜ëŠ” ì˜ì‚¬â€™ ì´ë ‡ê²Œ 2ê°€ì§€ í˜•íƒœ ëª¨ë‘ í‘œí˜„ ê°€ëŠ¥

### ManyToManyField íŠ¹ì§•

- ì–´ëŠ ëª¨ë¸ì—ì„œë“  ê´€ë ¨ ê°ì²´ì— ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” **ì–‘ë°©í–¥ ê´€ê³„**
- ë™ì¼í•œ ê´€ê³„ëŠ” í•œ ë²ˆë§Œ ì €ì¥ë˜ë©° **ì¤‘ë³µë˜ì§€ ì•ŠìŒ**
- ManyToManyFieldì˜ ëŒ€í‘œ ì¸ì 3ê°€ì§€
    1. related_name
        - ì—­ì°¸ì¡° ì´ë¦„ì„ ë³€ê²½í•  ë•Œ ì„¤ì •í•˜ëŠ” ì¸ì
        - ì—­ì°¸ì¡°ì‹œ ì‚¬ìš©í•˜ëŠ” manager nameì„ ë³€ê²½
            - ì•„ë˜ëŠ” â€˜patients_setâ€™(ê¸°ë³¸ê°’) ì„ â†’ â€˜patientsâ€™ë¡œ ë³€ê²½
            - ì´ë¦„ì„ ë³€ê²½í•˜ë©´ ë” ì´ìƒ ê¸°ë³¸ ê°’ ì‚¬ìš© ë¶ˆê°€
        
        ```python
        class Patient(models.Model):
            # ManyToManyField - related_name ì‘ì„±
            doctors = models.ManyToManyField(Doctor, related_name='patients')
            name = models.TextField()
        
            def __str__(self):
                return f'{self.pk}ë²ˆ í™˜ì {self.name}'
        ```
        
    2. symmetrical
        - ê´€ê³„ ì„¤ì • ì‹œ ëŒ€ì¹­ì— ëŒ€í•œ ì„¤ì •ì„ í•˜ëŠ” ì¸ì
        - ì˜ˆë¥¼ ë“¤ì–´ í•œ ëª…ì´ íŒ”ë¡œìš° í•˜ë©´ ë§íŒ”ë¡œìš°ê°€ ë¨
    3. through
        - ì§ì ‘ ìƒì„±í•œ ì¤‘ê°œ í…Œì´ë¸”ì„ ë“±ë¡í•˜ëŠ” ì¸ì

<aside>
ğŸ’¡

ì—­ì°¸ì¡°ì˜ í•„ìš”ì„±ê³¼ ì¥ì 

1. ë°ì´í„° ê´€ê³„ë¥¼ ì–‘ë°©í–¥ìœ¼ë¡œ íƒìƒ‰í•  ìˆ˜ ìˆë‹¤
2. ì¿¼ë¦¬ íš¨ìœ¨ì„±ì´ í–¥ìƒí•œë‹¤
3. ì½”ë“œ ê°€ë…ì„±ì´ ì˜¬ë¼ê°„ë‹¤
4. ê´€ê³„ë¥¼ ê°ì²´ì§€í–¥ì ìœ¼ë¡œ ì ‘ê·¼í•  ìˆ˜ ìˆì–´ í‘œí˜„ì´ ì‰¬ì›Œì§„ë‹¤. 
</aside>

# N:M ê´€ê³„ë¡œ ê²Œì‹œê¸€ ì¢‹ì•„ìš” ê¸°ëŠ¥ ì¶”ê°€í•´ë³´ì

### like url ìƒì„±

- ì–´ë–¤ ê²Œì‹œê¸€ì— ì¢‹ì•„ìš”ë¥¼ ë‚¨ê¸¸ì§€ê°€ í•„ìš”í•˜ê¸° ë•Œë¬¸ì— variable routingì„ í™œìš©

```python
# articles/urls.py
from django.urls import path
from . import views

app_name = 'articles'
urlpatterns = [
    path('', views.index, name='index'),
    path('<int:pk>/', views.detail, name='detail'),
    path('create/', views.create, name='create'),
    path('<int:pk>/delete/', views.delete, name='delete'),
    path('<int:pk>/update/', views.update, name='update'),
    path('<int:pk>/comments/', views.comments_create, name='comments_create'),
    path(
        '<int:article_pk>/comments/<int:comment_pk>/delete/',
        views.comments_delete,
        name='comments_delete',
    ),
    # ì¢‹ì•„ìš” url
    path('<int:article_pk>/likes/', views.likes, name='likes'),
]
```

### ì¢‹ì•„ìš” ê¸°ëŠ¥ì„ ì²˜ë¦¬í•´ì¤„ í•¨ìˆ˜

- ê¸°ì¡´ì— ì¢‹ì•„ìš”ë¥¼ ëˆ„ë¥¸ ìƒíƒœì´ë©´ ì·¨ì†Œ, ì•„ë‹ˆë©´ ì¢‹ì•„ìš”ë¥¼ ì²˜ë¦¬í•´ì£¼ê¸° ìœ„í•´ì„œ if-else í™œìš©

```python
# articles/views.py
# ì¢‹ì•„ìš” ì²˜ë¦¬ í•¨ìˆ˜
def likes(request, article_pk):
    # ì–´ë–¤ ê²Œì‹œê¸€ì— ì¢‹ì•„ìš”ë¥¼ ëˆ„ë¥´ëŠ” ê±´ì§€ ì¡°íšŒ
    article = Article.objects.get(pk=article_pk)

    # ì¢‹ì•¼ìš” ìƒì„±/ì·¨ì†Œì¸ì§€ í™•ì¸ -> ì¦‰ í™•ì¸í•´ë´ì•¼í•¨
    # ì£¼ì²´: ìœ ì €
    # ìœ ì €ê°€ í•´ë‹¹ ê²Œì‹œê¸€ì— ì¢‹ì•„ìš”ë¥¼ ëˆ„ë¥¸ ìœ ì € ëª©ë¡ì— í¬í•¨ë˜ì–´ ìˆëŠëƒ ì—†ëŠëƒ 
    if request.user in article.like_users.all():
        article.like_users.remove(request.user)
        # ì´ë ‡ê²Œí•´ë„ë¨: request.user.like_article.remove(article)
    else:
        article.like_users.add(request.user)
        # ì´ë ‡ê²Œí•´ë„ë¨: request.user.like_article.add(article)

    return redirect('articles:index')
```

### ì¢‹ì•„ìš” í¼ ì¶”ê°€

- ë©”ì¸ í˜ì´ì§€ì— ì¢‹ì•„ìš” í¼ ì¶”ê°€í•¨

```html
      <form action="{% url "articles:likes" article.pk %}" method="POST">
        {% csrf_token %}
        {% if request.user in article.like_users.all %}
          <input type="submit" value="ì¢‹ì•„ìš” ì·¨ì†Œ">
        {% else %}
          <input type="submit" value="ì¢‹ì•„ìš” ì·¨ì†Œ">
        {% endif %}
      </form>
```

## ê²°ê³¼ í™”ë©´

- ì¢‹ì•„ìš” ëˆ„ë¦„
    
    ![ì¢‹ì•„ìš”ëˆ„ë¦„.png](./ì¢‹ì•„ìš”ëˆ„ë¦„.png)
    
- ëˆ„ë¥´ê³  ë‚œ DB
    - 1ë²ˆ ê²Œì‹œê¸€ ì“´ ìœ ì €ê°€ ìŠ¤ìŠ¤ë¡œ ì¢‹ì•„ìš”ë¥¼ ë‹¬ì•˜ìŒ.
        
        ![likedb.png](./likedb.png)