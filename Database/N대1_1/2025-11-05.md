1ëŒ€N ê´€ê³„ì—ì„œ ê´€ê³„í‘œì‹œë¥¼ ìœ„í•œ ì™¸ë˜í‚¤ëŠ” ì–´ë””ì— ìˆì–´ì•¼ í• ê¹Œ? 1ì—? N ì—? 

Nìª½ì— ë„£ì•¼í•¨. Nìª½ì€ ì¤‘ë³µí•´ì„œ ì—¬ëŸ¬ 1ì— ìˆì„ ìˆ˜ ì—†ê¸° ë•Œë¬¸ì— êµ¬ì¡°ê°€ ê¹¨ì§€ëŠ” ê²½ìš°ê°€ ë°œìƒí•˜ì§€ ì•ŠìŒ 

## ëŒ“ê¸€(N) ëª¨ë¸ ì •ì˜

### ForeignKey(to, on_delete)

- í•œ ëª¨ë¸ì´ ë‹¤ë¥¸ ëª¨ë¸ì„ ì°¸ì¡°í•˜ëŠ” ê´€ê³„ë¥¼ ì„¤ì •í•˜ëŠ” í•„ë“œ
    - N:1 ê´€ê³„ í‘œí˜„í•  ë•Œ ì‚¬ìš©
    - ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì™¸ë˜ í‚¤ë¡œ êµ¬í˜„ë¨

 

- to ì†ì„±
    - ì°¸ì¡°í•˜ëŠ” ëª¨ë¸ class ì´ë¦„(N:1ì—ì„œ Nì´ ì•„ë‹Œ 1ì˜ class ì •ë³´)
    - on_delete ì†ì„±
        - ì™¸ë˜ í‚¤ê°€ ì°¸ì¡°í•˜ëŠ” ê°ì²´(1)ê°€ ì‚¬ë¼ì¡Œì„ ë•Œ, ì™¸ë˜ í‚¤ë¥¼ ê°€ì§„ ê°ì²´(N)ë¥¼ ì–´ë–»ê²Œ ì²˜ë¦¬í•  ì§€ë¥¼ ì •ì˜í•˜ëŠ” ì„¤ì •(ë°ì´í„° ë¬´ê²°ì„±)
        - ì¢…ë¥˜
            - `CASCADE`
                - ì°¸ì¡° ëœ ê°ì²´ê°€ ì‚­ì œ ë  ë•Œ ì´ë¥¼ ì°¸ì¡°í•˜ëŠ” ëª¨ë“  ê°ì²´ ê°™ì´ ì‚­ì œ
            - `PROTECT`
                - ì‚­ì œ í•˜ë ¤ëŠ” ë¶€ëª¨ ê°ì²´ì— ìì‹ ê°ì²´ê°€ ì¡´ì¬í•œë‹¤ë©´ ë¶€ëª¨ ê°ì²´ë¥¼ ì‚­ì œí•˜ì§€ ëª»í•˜ë„ë¡ í•¨
            - `SET_NULL`
                - ë¶€ëª¨ ê°ì²´ê°€ ì‚­ì œë˜ë©´, í•´ë‹¹ í•„ë“œì— ê°’ì´ NULLì´ ì €ì¥ë˜ë„ë¡ ì§€ì •
                - ë‹¨, ForeignKey í•„ë“œ ì„¤ì •ì´ null = Trueê°€ ì„¤ì • ë˜ì–´ì•¼ í•¨
            

### ì™¸ë˜í‚¤(ForeignKey) ì„¤ê³„ ì›ì¹™

- **ì™¸ë˜í‚¤ í•„ë“œëª…ì€ ì°¸ì¡°í•˜ëŠ” í…Œì´ë¸”ì˜ ë‹¨ìˆ˜í˜•ìœ¼ë¡œ ì‘ì„±**
    
    ì˜ˆ:
    
    ```python
    class Comment(models.Model):
        article = models.ForeignKey(Article, on_delete=models.CASCADE)
    
    ```
    
- DjangoëŠ” ì‹¤ì œ DB í…Œì´ë¸” ìƒì„± ì‹œ ìë™ìœ¼ë¡œ `article_id` ì»¬ëŸ¼ì„ ìƒì„±í•¨.
    
    ğŸ‘‰ ì¦‰, **ì„¤ê³„ ì‹œ í•„ë“œëª…ì— `_id`ë¥¼ ì§ì ‘ ë¶™ì¼ í•„ìš”ê°€ ì—†ë‹¤.**
    

---

### ORMìœ¼ë¡œ ë°ì´í„° ë“±ë¡í•˜ê¸°

### ê²Œì‹œê¸€ ë“±ë¡

```python
article = Article.objects.create(title='ì œëª©', content='ë‚´ìš©')
```

### ëŒ“ê¸€ ë“±ë¡

```python
comment = Comment.objects.create(
    content='ì¢‹ì€ ê¸€ì´ë„¤ìš”!',
    article=article   # ì™¸ë˜í‚¤ì— 'ê°ì²´ ë©ì–´ë¦¬'ë¥¼ ì§ì ‘ ì—°ê²°
)
```

> ëŒ“ê¸€ë§Œ ë‹¨ë…ìœ¼ë¡œ ë“±ë¡í•˜ë ¤ í•˜ë©´
> 
> 
> `NOT NULL constraint failed: comment.article_id`
> 
> ë¼ëŠ” ì—ëŸ¬ê°€ ë°œìƒí•¨ (ì™¸ë˜í‚¤ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ `NOT NULL` ì¡°ê±´ì´ ê±¸ë ¤ ìˆìŒ)
> 

---

### ì™¸ë˜í‚¤ë¥¼ ê°ì²´ë¡œ ë„£ì–´ì•¼ í•˜ëŠ” ì´ìœ 

- `article=article`ì²˜ëŸ¼ **ê°ì²´ ìì²´ë¥¼ ì „ë‹¬í•´ì•¼ í•œë‹¤.**
- DBë¥¼ ì§ì ‘ ì¡°ì‘í•  ë• ìˆ«ì(PK)ë§Œ ë„£ìœ¼ë©´ ë˜ì§€ë§Œ,
    
    ORMì—ì„œëŠ” `article_id=1` ì‹ìœ¼ë¡œ ë„£ìœ¼ë©´ **ìœ íš¨ì„± ê²€ì‚¬ê°€ ìƒëµë˜ì–´ ì˜ëª»ëœ ê°’ì´ ë“¤ì–´ê°ˆ ìœ„í—˜**ì´ ìˆë‹¤.
    
    ğŸ‘‰ ë”°ë¼ì„œ **ê°ì²´ë¥¼ í†µì§¸ë¡œ ë„£ëŠ” ë°©ì‹**ì´ ì•ˆì „í•˜ê³  ê¶Œì¥ë¨.
    

---

### ForeignKeyë¥¼ í†µí•œ ì ‘ê·¼

### ì°¸ì¡° (ëŒ“ê¸€ â†’ ê²Œì‹œê¸€)

- ì§ì ‘ ëŒ€ìƒì˜ ì •ë³´ë¥¼ ì €ì¥í•˜ê³  í•„ìš”í•  ë•Œ í™œìš©í•˜ëŠ” ê²ƒ

```python
comment.article.content
```

â†’ ëŒ“ê¸€ì´ ë‹¬ë¦° ê²Œì‹œê¸€ì˜ ë‚´ìš©ì„ ê°€ì ¸ì˜¬ ìˆ˜ ìˆìŒ.

### ì—­ì°¸ì¡° (ê²Œì‹œê¸€ â†’ ëŒ“ê¸€)

- ëˆ„ê°€ ë‚˜ë¥¼ ì°¸ì¡°í•˜ëŠ”ì§€ ê±°ê¾¸ë¡œ ì¡°íšŒí•˜ëŠ” ê²ƒ

```python
article.comment_set.all()
```

â†’ í•´ë‹¹ ê²Œì‹œê¸€ì— ë‹¬ë¦° ëª¨ë“  ëŒ“ê¸€ ëª©ë¡ì„ ê°€ì ¸ì˜´.

---

### ì—­ì°¸ì¡° ê´€ë ¨ ê°œë…

- `Article` ëª¨ë¸ì—ëŠ” `Comment`ë¥¼ ë‹´ëŠ” í•„ë“œê°€ **ì§ì ‘ ì¡´ì¬í•˜ì§€ ì•ŠìŒ**
- ëŒ€ì‹  Djangoê°€ ìë™ìœ¼ë¡œ **Related Manager** (`comment_set`)ë¥¼ ìƒì„±í•¨
    
    ```
    ëª¨ë¸ì¸ìŠ¤í„´ìŠ¤.ì—­ì°¸ì¡°ì´ë¦„.QuerySet API
    ex) article.comment_set.all()
    ```
    

### related manager ì´ë¦„ ê·œì¹™

- ëª¨ë¸ í´ë˜ìŠ¤ëª… + _set ì´ ê¸°ë³¸ ê°’ì´ë©° Djangoì—ì„œ ìë™ìœ¼ë¡œ ìƒì„±í•´ ì¤Œ
- ê´€ê³„ë¥¼ ì§ì ‘ ì •ì˜í•˜ì§€ ì•Šì€ ëª¨ë¸ì—ì„œ ì—°ê²°ëœ ê°ì²´ë“¤ì„ ì¡°íšŒí•  ìˆ˜ ìˆê²Œ í•¨
- íŠ¹ì • ëŒ“ê¸€ì˜ ê²Œì‹œê¸€ ì°¸ì¡°
    - comment.article
- íŠ¹ì • ê²Œì‹œê¸€ì˜ ëŒ“ê¸€ ëª©ë¡ ì—­ì°¸ì¡°
    - article.comment_set.all()

## ëŒ“ê¸€ CREATE

### 1. CommentForm ì •ì˜

> ì‚¬ìš©ìë¡œë¶€í„° ëŒ“ê¸€ ë°ì´í„°ë¥¼ ì…ë ¥ë°›ê¸° ìœ„í•œ ModelForm ì‘ì„±
> 

```python
# articles/forms.py
from django import forms
from .models import Article, Comment

class CommentForm(forms.ModelForm):
    class Meta:
        model = Comment
        fields = '__all__'

```

---

### 2. detail viewì—ì„œ CommentForm ì „ë‹¬

> ê²Œì‹œê¸€ ìƒì„¸ í˜ì´ì§€ì—ì„œ ëŒ“ê¸€ ì‘ì„± í¼ì„ í•¨ê»˜ ë Œë”ë§í•˜ê¸° ìœ„í•¨
> 

```python
# articles/views.py
def detail(request, pk):
    article = Article.objects.get(pk=pk)
    comment_form = CommentForm()
    context = {
        'article': article,
        'comment_form': comment_form,
    }
    return render(request, 'articles/detail.html', context)

```

---

### 3. detail.htmlì—ì„œ ëŒ“ê¸€ ì‘ì„± í¼ ì¶œë ¥

> {{ comment_form }}ë¥¼ í†µí•´ formì„ ìë™ ë Œë”ë§
> 

```html
<!-- articles/detail.html -->
<hr>
<form action="#" method="POST">
  {% csrf_token %}
  {{ comment_form }}
  <input type="submit" value="CREATE">
</form>

```

---

### 4. ì™¸ë˜í‚¤(FK) í•„ë“œ ë¬¸ì œ ë°œìƒ

> Comment ëª¨ë¸ì˜ article ì™¸ë˜í‚¤ë„ í¼ì— ìë™ í¬í•¨ë˜ì–´ ì„ íƒì°½ìœ¼ë¡œ í‘œì‹œë¨
> 
> 
> â†’ í•˜ì§€ë§Œ **ì™¸ë˜í‚¤ëŠ” ì‚¬ìš©ìê°€ ì§ì ‘ ì…ë ¥í•˜ë©´ ì•ˆ ë¨**
> 

ğŸ“Œ ë¬¸ì œì 

- ì‚¬ìš©ìê°€ ì„ì˜ë¡œ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” Articleì„ ì„ íƒí•  ìˆ˜ë„ ìˆìŒ
- ì¦‰, ì˜ëª»ëœ ë°ì´í„°ê°€ DBì— ì €ì¥ë  ìœ„í—˜

---

### 5. CommentFormì—ì„œ ì™¸ë˜í‚¤ í•„ë“œ ì œì™¸

> ì™¸ë˜í‚¤ articleì€ viewì—ì„œ ì§ì ‘ ì²˜ë¦¬í•˜ë¯€ë¡œ, formì—ëŠ” ì œì™¸ì‹œí‚´
> 

```python
# articles/forms.py
class CommentForm(forms.ModelForm):
    class Meta:
        model = Comment
        fields = ('content', )   # articleì€ ì œì™¸

```

> âš ï¸ tuple ì£¼ì˜: ìš”ì†Œê°€ 1ê°œì¼ ê²½ìš° ë°˜ë“œì‹œ ì‰¼í‘œ(,) ë¶™ì´ê¸°!
> 

---

### 6. ëŒ“ê¸€ ì‘ì„± ì‹œ ì™¸ë˜í‚¤ ë°ì´í„°ëŠ” ì–´ë””ì„œ?

> detail í˜ì´ì§€ì˜ URLì— ì´ë¯¸ ê²Œì‹œê¸€ì˜ pkê°€ í¬í•¨ë˜ì–´ ìˆìŒ
> 
> 
> â†’ variable routingì„ í†µí•´ view í•¨ìˆ˜ì—ì„œ í•´ë‹¹ ê²Œì‹œê¸€ ê°ì²´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ìˆìŒ
> 

```python
# articles/urls.py
path('<int:pk>/', views.detail, name='detail'),

```

---

### 7. ëŒ“ê¸€ ì €ì¥ì€ ë³„ë„ì˜ view í•¨ìˆ˜ë¡œ ì²˜ë¦¬

> â€œë‹¨ì¼ ì±…ì„ ì›ì¹™â€ì— ë”°ë¼ detailê³¼ createë¥¼ ë¶„ë¦¬
> 
> 
> ëŒ“ê¸€ ì‘ì„± ì‹œ ê²Œì‹œê¸€ pkë¥¼ í•¨ê»˜ ì „ë‹¬
> 

```html
<!-- articles/detail.html -->
<form action="{% url 'articles:comments_create' article.pk %}" method="POST">
  {% csrf_token %}
  {{ comment_form }}
  <input type="submit" value="CREATE">
</form>

```

```python
# articles/urls.py
urlpatterns = [
    ...
    path('<int:pk>/comments/', views.comments_create, name='comments_create'),
]

```

---

### 8. comments_create í•¨ìˆ˜ êµ¬í˜„

> ëŒ“ê¸€ ì‘ì„±ì€ POST ìš”ì²­ìœ¼ë¡œë§Œ ì²˜ë¦¬
> 
> 
> GETì€ detail í•¨ìˆ˜ì—ì„œ ì´ë¯¸ ë‹´ë‹¹í•¨
> 

```python
# articles/views.py
def comments_create(request, pk):
    article = Article.objects.get(pk=pk)                 # â‘  ê²Œì‹œê¸€ ì¡°íšŒ
    comment_form = CommentForm(request.POST)             # â‘¡ ì…ë ¥ ë°ì´í„° ë°›ê¸°

    if comment_form.is_valid():                          # â‘¢ ìœ íš¨ì„± ê²€ì‚¬ í†µê³¼ ì‹œ
        comment = comment_form.save(commit=False)        #   DBì— ì €ì¥ ì „ ì¤‘ê°„ ê°ì²´ ìƒì„±
        comment.article = article                        # â‘£ ì™¸ë˜í‚¤ ì§ì ‘ ì—°ê²°
        comment.save()                                   # â‘¤ ìµœì¢… ì €ì¥
        return redirect('articles:detail', article.pk)   # â‘¥ ì €ì¥ í›„ ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™

    # â‘¦ ìœ íš¨ì„± ì‹¤íŒ¨ ì‹œ ë‹¤ì‹œ detail.html ë Œë”ë§
    context = {
        'article': article,
        'comment_form': comment_form,
    }
    return render(request, 'articles/detail.html', context)
```

### 9. URLë¡œ ì „ë‹¬ë°›ì€ `article.pk` ì´ìš©

> URLì˜ pkë¡œ í•´ë‹¹ ê²Œì‹œê¸€ ì •ë³´ë¥¼ ê°€ì ¸ì™€ ëŒ“ê¸€ ìƒì„± ì‹œ ì—°ê²°í•´ì•¼ í•¨
> 

```python
# articles/views.py
article = Article.objects.get(pk=pk)

```

- ëŒ“ê¸€ì„ ìƒì„±í•  ë•Œ ë°˜ë“œì‹œ **ê²Œì‹œê¸€(article) ê°ì²´**ë¥¼ í•¨ê»˜ ì¶”ê°€í•´ì•¼ í•¨.
- ì¦‰, ëŒ“ê¸€ ì‘ì„± ì‹œ ì™¸ë˜í‚¤(FK) í•„ë“œì— í•´ë‹¹ ê²Œì‹œê¸€ ê°ì²´ë¥¼ ì—°ê²°í•´ì•¼ í•¨.

---

### 10. `save(commit=False)` ì‚¬ìš© ì´ìœ 

### ê¸°ë³¸ ë™ì‘

```python
comment_form.save()
# â†’ commit=Trueê°€ ê¸°ë³¸ê°’
# â†’ ì¦‰ì‹œ DBì— ì €ì¥ (save ìš”ì²­ ì „ì†¡)
```

### commit=Falseë¡œ ë³€ê²½

```python
comment = comment_form.save(commit=False)
```

- DBì— ë°”ë¡œ ì €ì¥í•˜ì§€ ì•Šê³  **ì¸ìŠ¤í„´ìŠ¤ë§Œ ìƒì„±**
- ì´í›„ í•„ìš”í•œ ì •ë³´ë¥¼ ì¶”ê°€í•œ ë’¤ `.save()`ë¡œ ìµœì¢… ì €ì¥ ê°€ëŠ¥

â†’ **ê²Œì‹œê¸€ ì •ë³´ë¥¼ ì—°ê²°í•œ í›„** ì €ì¥í•  ìˆ˜ ìˆìŒ

---

### 11. ìµœì¢… ëŒ“ê¸€ ìƒì„± ë¡œì§

```python
# articles/views.py
def comments_create(request, pk):
    article = Article.objects.get(pk=pk)
    comment_form = CommentForm(request.POST)

    if comment_form.is_valid():
        comment = comment_form.save(commit=False)  # â‘  DBì— ì €ì¥í•˜ì§€ ì•Šê³  ì¸ìŠ¤í„´ìŠ¤ë§Œ ìƒì„±
        comment.article = article                   # â‘¡ ëŒ“ê¸€ì— ê²Œì‹œê¸€ ì •ë³´ ì¶”ê°€ (FK ì—°ê²°)
        comment.save()                              # â‘¢ DBì— ìµœì¢… ì €ì¥
        return redirect('articles:detail', article.pk)

    # ìœ íš¨ì„± ê²€ì‚¬ ì‹¤íŒ¨ ì‹œ
    context = {
        'article': article,
        'comment_form': comment_form,
    }
    return render(request, 'articles/detail.html', context)
```

### ğŸ’¡ ìš”ì•½

| ë‹¨ê³„ | ë‚´ìš© |
| --- | --- |
| â‘  | `save(commit=False)` â†’ DB ì €ì¥ ë³´ë¥˜ |
| â‘¡ | `comment.article = article` â†’ ê²Œì‹œê¸€ ì •ë³´ ì—°ê²° |
| â‘¢ | `comment.save()` â†’ ìµœì¢… ì €ì¥ ìš”ì²­ |

---

### 12. DBì—ì„œ í™•ì¸

> ëŒ“ê¸€ ì‘ì„± í›„ DB í…Œì´ë¸”ì„ ë³´ë©´ article_id ì»¬ëŸ¼ì— ê²Œì‹œê¸€ ì •ë³´ê°€ ì €ì¥ë˜ì–´ ìˆìŒ.
> 

| id | content | article_id |
| --- | --- | --- |
| 1 | first comment | 1 |
| 2 | second comment | 1 |
| 3 | 1ë²ˆ ê²Œì‹œê¸€ ëŒ“ê¸€ ì‘ì„±! | 1 |

ğŸ“Œ ì¦‰, í•˜ë‚˜ì˜ ê²Œì‹œê¸€(`article_id=1`)ì— ì—¬ëŸ¬ ê°œì˜ ëŒ“ê¸€ì´ ì—°ê²°ëœ í˜•íƒœ

â†’ **1 : N ê´€ê³„(ManyToOne)** ê´€ê³„ê°€ ì˜¬ë°”ë¥´ê²Œ ì‘ë™í•œ ê²ƒ 

---

## ëŒ“ê¸€ READ/ Delete

```python
app_name = 'articles'
urlpatterns = [
    path('', views.index, name='index'),
    path('<int:pk>/', views.detail, name='detail'),
    path('create/', views.create, name='create'),
    path('<int:pk>/delete/', views.delete, name='delete'),
    path('<int:pk>/update/', views.update, name='update'),
    # ëŒ“ê¸€ ìƒì„±
    path('<int:pk>/comments/', views.comments_create, name='comments_create'),
    # ëŒ“ê¸€ ì‚­ì œ
    path('<int:article_pk>/comments/<int:comment_pk>/delete/', views.comments_delete, name='comments_delete'),
]

```

```python
def detail(request, pk):
    article = Article.objects.get(pk=pk)
    comment_form = CommentForm()

    # íŠ¹ì • ê²Œì‹œê¸€ì— ì‘ì„±ëœ ëª¨ë“  ëŒ“ê¸€ ì¡°íšŒ(ì—­ì°¸ì¡°)
    comments = article.comment_set.all()

    context = {
        'article': article,
        'comment_form': comment_form,
        'comments': comments,
    }
    return render(request, 'articles/detail.html', context)

def comments_delete(request, article_pk, comment_pk):
    comment = Comment.objects.get(pk=comment_pk)
    comment.delete()
    return redirect('articles:detail', article_pk)
```

```html
  <ul>
  {% for comment in comments %}
    <li>
      {{ comment.content }}
      <form action= "{% url "articles:comments_delete" article.pk comment.pk %}" method="POST">
        {% csrf_token %}
        <input type="submit" value="ì‚­ì œ">
      </form>
    </li>
  {% endfor %}
  </ul>
```